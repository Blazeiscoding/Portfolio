---
import { Icon } from "astro-icon/components";

interface Props {
  username: string;
}

const { username } = Astro.props;
---

<div class="github-activity w-full">
  <div class="flex items-center gap-2 mb-4">
    <Icon name="carbon:logo-github" class="w-5 h-5 text-primary" aria-hidden="true" />
    <h3 class="text-lg font-bold text-base-content">GitHub Activity</h3>
    <a 
      href={`https://github.com/${username}`}
      target="_blank"
      rel="noopener noreferrer"
      class="ml-auto text-sm text-primary hover:underline"
    >
      @{username}
    </a>
  </div>
  
  <div class="contribution-wrapper rounded-xl border border-base-content/20 bg-base-200/80 backdrop-blur-md p-4 overflow-hidden">
    <img 
      src={`https://ghchart.rshah.org/6366f1/${username}`}
      alt={`${username}'s GitHub contribution graph`}
      class="w-full h-auto contribution-graph"
      loading="lazy"
      decoding="async"
    />
  </div>
  
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4" id="github-stats">
    <div class="stat-card rounded-lg border border-base-content/20 bg-base-200/80 backdrop-blur-md p-3 text-center hover:border-primary/50 transition-all">
      <div class="text-2xl font-bold stat-number" id="repos-count">--</div>
      <div class="text-xs text-base-content/70">Repositories</div>
    </div>
    <div class="stat-card rounded-lg border border-base-content/20 bg-base-200/80 backdrop-blur-md p-3 text-center hover:border-primary/50 transition-all">
      <div class="text-2xl font-bold stat-number" id="followers-count">--</div>
      <div class="text-xs text-base-content/70">Followers</div>
    </div>
    <div class="stat-card rounded-lg border border-base-content/20 bg-base-200/80 backdrop-blur-md p-3 text-center hover:border-primary/50 transition-all">
      <div class="text-2xl font-bold stat-number" id="following-count">--</div>
      <div class="text-xs text-base-content/70">Following</div>
    </div>
    <div class="stat-card rounded-lg border border-base-content/20 bg-base-200/80 backdrop-blur-md p-3 text-center hover:border-primary/50 transition-all">
      <div class="text-2xl font-bold stat-number" id="stars-count">--</div>
      <div class="text-xs text-base-content/70">Total Stars</div>
    </div>
  </div>
</div>

<script define:vars={{ username }}>
  // Animated counter with easing
  function animateCounter(element, target, duration = 1500) {
    if (!element) return;
    
    const start = 0;
    const startTime = performance.now();
    
    // Easing function (ease-out cubic)
    const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);
    
    function update(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easedProgress = easeOutCubic(progress);
      const current = Math.floor(start + (target - start) * easedProgress);
      
      element.textContent = current.toString();
      
      if (progress < 1) {
        requestAnimationFrame(update);
      } else {
        element.textContent = target.toString();
      }
    }
    
    requestAnimationFrame(update);
  }
  
  // Store fetched data for animation
  let statsData = null;
  let hasAnimated = false;
  let hasFetched = false;
  
  async function fetchGitHubStats() {
    // Prevent duplicate fetches
    if (hasFetched) return;
    hasFetched = true;
    
    const reposEl = document.getElementById('repos-count');
    const followersEl = document.getElementById('followers-count');
    const followingEl = document.getElementById('following-count');
    const starsEl = document.getElementById('stars-count');
    
    try {
      const res = await fetch(`/api/github-stats?username=${username}`);
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: Failed to fetch GitHub stats`);
      }
      
      statsData = await res.json();
      
      // Set initial values to 0 (will animate when scrolled into view)
      if (reposEl) reposEl.textContent = '0';
      if (followersEl) followersEl.textContent = '0';
      if (followingEl) followingEl.textContent = '0';
      if (starsEl) starsEl.textContent = '0';
      
      if (statsData.hasToken && statsData.privateRepos > 0) {
        const reposLabel = document.querySelector('#repos-count + div');
        if (reposLabel) {
          reposLabel.innerHTML = `Repos <span class="private-repos-label text-[10px]">(+${statsData.privateRepos} private)</span>`;
        }
      }
      
      // Check if already in view
      checkAndAnimate();
    } catch (error) {
      console.error('Failed to fetch GitHub stats:', error);
      // Show error state
      if (reposEl) reposEl.textContent = '--';
      if (followersEl) followersEl.textContent = '--';
      if (followingEl) followingEl.textContent = '--';
      if (starsEl) starsEl.textContent = '--';
    }
  }
  
  function animateStats() {
    if (!statsData || hasAnimated) return;
    hasAnimated = true;
    
    const reposEl = document.getElementById('repos-count');
    const followersEl = document.getElementById('followers-count');
    const followingEl = document.getElementById('following-count');
    const starsEl = document.getElementById('stars-count');
    
    // Stagger animations for visual effect
    animateCounter(reposEl, statsData.repos || 0, 1200);
    setTimeout(() => {
      animateCounter(followersEl, statsData.followers || 0, 1200);
    }, 150);
    setTimeout(() => {
      animateCounter(followingEl, statsData.following || 0, 1200);
    }, 300);
    setTimeout(() => {
      animateCounter(starsEl, statsData.stars || 0, 1200);
    }, 450);
  }
  
  function checkAndAnimate() {
    const statsContainer = document.getElementById('github-stats');
    if (!statsContainer || !statsData) return;
    
    // Setup Intersection Observer for scroll-triggered animation
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !hasAnimated) {
          animateStats();
          observer.disconnect();
        }
      });
    }, {
      threshold: 0.3, // Trigger when 30% visible
      rootMargin: '0px 0px -50px 0px'
    });
    
    observer.observe(statsContainer);
  }
  
  // Single fetch call - script runs at end of body so DOM is ready
  fetchGitHubStats();
</script>

<style is:global>
  .contribution-graph {
    filter: grayscale(0);
  }
  
  [data-theme="black"] .contribution-graph {
    filter: invert(1) hue-rotate(180deg);
  }
  
  .stat-number {
    color: oklch(var(--p));
  }
  
  [data-theme="black"] .stat-number {
    color: #ffffff !important;
  }
  
  .private-repos-label {
    color: oklch(var(--p));
  }
  
  [data-theme="black"] .private-repos-label {
    color: #ffffff !important;
  }
  
  [data-theme="black"] .stat-card {
    background-color: rgba(30, 30, 30, 0.9) !important;
    border-color: rgba(255, 255, 255, 0.2) !important;
  }
  
  [data-theme="black"] .contribution-wrapper {
    background-color: rgba(30, 30, 30, 0.9) !important;
    border-color: rgba(255, 255, 255, 0.2) !important;
  }
  
  .stat-card {
    transition: transform 0.2s ease, border-color 0.2s ease;
  }
  
  .stat-card:hover {
    transform: translateY(-2px);
  }
</style>
