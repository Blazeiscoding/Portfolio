---
import { Icon } from "astro-icon/components";

interface Props {
  username: string;
}

const { username } = Astro.props;
---

<div class="github-activity w-full">
  <div class="flex items-center gap-2 mb-4">
    <Icon name="carbon:logo-github" class="w-5 h-5 text-primary animate-pulse" aria-hidden="true" />
    <h3 class="text-lg font-bold text-base-content">GitHub Activity</h3>
    <a 
      href={`https://github.com/${username}`}
      target="_blank"
      rel="noopener noreferrer"
      class="ml-auto text-sm text-primary hover:underline hover:scale-105 transition-transform"
    >
      @{username}
    </a>
  </div>
  
  <!-- Contribution Graph with Skeleton -->
  <div class="contribution-wrapper glass-panel rounded-xl p-4 overflow-hidden relative">
    <!-- Skeleton loader -->
    <div class="skeleton-graph absolute inset-4 rounded-lg animate-pulse bg-gradient-to-r from-base-300 via-base-200 to-base-300 bg-[length:200%_100%]" id="graph-skeleton"></div>
    <img 
      src={`https://ghchart.rshah.org/6366f1/${username}`}
      alt={`${username}'s GitHub contribution graph`}
      class="w-full h-auto contribution-graph opacity-0 transition-opacity duration-500"
      loading="lazy"
      decoding="async"
      width="722"
      height="112"
      id="contribution-img"
      onload="this.classList.remove('opacity-0'); document.getElementById('graph-skeleton')?.classList.add('hidden');"
    />
  </div>
  
  <!-- Stats Grid with Skeleton -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4" id="github-stats">
    <div class="stat-card glass-panel rounded-xl p-4 text-center group" data-stat="repos">
      <div class="skeleton-stat" id="skeleton-repos">
        <div class="h-8 w-12 mx-auto rounded bg-base-300 animate-pulse mb-2"></div>
        <div class="h-3 w-16 mx-auto rounded bg-base-300 animate-pulse"></div>
      </div>
      <div class="stat-content hidden" id="content-repos">
        <div class="text-2xl font-bold stat-number group-hover:scale-110 transition-transform" id="repos-count">0</div>
        <div class="text-xs text-base-content/70 mt-1">Repositories</div>
      </div>
    </div>
    
    <div class="stat-card glass-panel rounded-xl p-4 text-center group" data-stat="followers">
      <div class="skeleton-stat" id="skeleton-followers">
        <div class="h-8 w-12 mx-auto rounded bg-base-300 animate-pulse mb-2"></div>
        <div class="h-3 w-16 mx-auto rounded bg-base-300 animate-pulse"></div>
      </div>
      <div class="stat-content hidden" id="content-followers">
        <div class="text-2xl font-bold stat-number group-hover:scale-110 transition-transform" id="followers-count">0</div>
        <div class="text-xs text-base-content/70 mt-1">Followers</div>
      </div>
    </div>
    
    <div class="stat-card glass-panel rounded-xl p-4 text-center group" data-stat="following">
      <div class="skeleton-stat" id="skeleton-following">
        <div class="h-8 w-12 mx-auto rounded bg-base-300 animate-pulse mb-2"></div>
        <div class="h-3 w-16 mx-auto rounded bg-base-300 animate-pulse"></div>
      </div>
      <div class="stat-content hidden" id="content-following">
        <div class="text-2xl font-bold stat-number group-hover:scale-110 transition-transform" id="following-count">0</div>
        <div class="text-xs text-base-content/70 mt-1">Following</div>
      </div>
    </div>
    
    <div class="stat-card glass-panel rounded-xl p-4 text-center group" data-stat="stars">
      <div class="skeleton-stat" id="skeleton-stars">
        <div class="h-8 w-12 mx-auto rounded bg-base-300 animate-pulse mb-2"></div>
        <div class="h-3 w-16 mx-auto rounded bg-base-300 animate-pulse"></div>
      </div>
      <div class="stat-content hidden" id="content-stars">
        <div class="text-2xl font-bold stat-number group-hover:scale-110 transition-transform" id="stars-count">0</div>
        <div class="text-xs text-base-content/70 mt-1">Total Stars</div>
      </div>
    </div>
  </div>
  
  <!-- Error State (hidden by default) -->
  <div id="github-error" class="hidden glass-panel rounded-xl p-6 mt-4 text-center">
    <Icon name="carbon:warning" class="w-8 h-8 mx-auto text-warning mb-2" aria-hidden="true" />
    <p class="text-base-content/80 text-sm mb-3">Unable to load GitHub stats</p>
    <button 
      id="github-retry" 
      class="btn btn-sm btn-outline btn-primary gap-2"
      aria-label="Retry loading GitHub stats"
    >
      <Icon name="carbon:restart" class="w-4 h-4" aria-hidden="true" />
      Retry
    </button>
  </div>
</div>

<script define:vars={{ username }}>
  function animateCounter(element, target, duration = 1500) {
    if (!element) return;
    
    const start = 0;
    const startTime = performance.now();
    
    const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);
    
    function update(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easedProgress = easeOutCubic(progress);
      const current = Math.floor(start + (target - start) * easedProgress);
      
      element.textContent = current.toString();
      
      if (progress < 1) {
        requestAnimationFrame(update);
      } else {
        element.textContent = target.toString();
      }
    }
    
    requestAnimationFrame(update);
  }
  
  function revealStat(statType, delay = 0) {
    setTimeout(() => {
      const skeleton = document.getElementById(`skeleton-${statType}`);
      const content = document.getElementById(`content-${statType}`);
      
      if (skeleton && content) {
        skeleton.classList.add('hidden');
        content.classList.remove('hidden');
        content.classList.add('animate-fade-in');
      }
    }, delay);
  }
  
  let statsData = null;
  let hasAnimated = false;
  let hasFetched = false;
  
  async function fetchGitHubStats() {
    if (hasFetched) return;
    hasFetched = true;
    
    const reposEl = document.getElementById('repos-count');
    const followersEl = document.getElementById('followers-count');
    const followingEl = document.getElementById('following-count');
    const starsEl = document.getElementById('stars-count');
    
    try {
      const res = await fetch(`/api/github-stats?username=${username}`);
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: Failed to fetch GitHub stats`);
      }
      
      statsData = await res.json();
      
      revealStat('repos', 100);
      revealStat('followers', 200);
      revealStat('following', 300);
      revealStat('stars', 400);
      
      if (reposEl) reposEl.textContent = '0';
      if (followersEl) followersEl.textContent = '0';
      if (followingEl) followingEl.textContent = '0';
      if (starsEl) starsEl.textContent = '0';
      
      if (statsData.hasToken && statsData.privateRepos > 0) {
        const reposLabel = document.querySelector('#repos-count + div');
        if (reposLabel) {
          reposLabel.innerHTML = `Repos <span class="private-repos-label text-[10px]">(+${statsData.privateRepos} private)</span>`;
        }
      }
      
      checkAndAnimate();
    } catch (error) {
      console.error('Failed to fetch GitHub stats:', error);
      
      // Show error state
      const errorEl = document.getElementById('github-error');
      const statsEl = document.getElementById('github-stats');
      if (errorEl && statsEl) {
        statsEl.classList.add('hidden');
        errorEl.classList.remove('hidden');
      }
      
      // Setup retry button
      const retryBtn = document.getElementById('github-retry');
      if (retryBtn) {
        retryBtn.addEventListener('click', () => {
          hasFetched = false;
          if (errorEl) errorEl.classList.add('hidden');
          if (statsEl) statsEl.classList.remove('hidden');
          fetchGitHubStats();
        });
      }
    }
  }
  
  function animateStats() {
    if (!statsData || hasAnimated) return;
    hasAnimated = true;
    
    const reposEl = document.getElementById('repos-count');
    const followersEl = document.getElementById('followers-count');
    const followingEl = document.getElementById('following-count');
    const starsEl = document.getElementById('stars-count');
    
    animateCounter(reposEl, statsData.repos || 0, 1200);
    setTimeout(() => {
      animateCounter(followersEl, statsData.followers || 0, 1200);
    }, 150);
    setTimeout(() => {
      animateCounter(followingEl, statsData.following || 0, 1200);
    }, 300);
    setTimeout(() => {
      animateCounter(starsEl, statsData.stars || 0, 1200);
    }, 450);
  }
  
  function checkAndAnimate() {
    const statsContainer = document.getElementById('github-stats');
    if (!statsContainer || !statsData) return;
    
    // Setup Intersection Observer for scroll-triggered animation
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !hasAnimated) {
          animateStats();
          observer.disconnect();
        }
      });
    }, {
      threshold: 0.3, // Trigger when 30% visible
      rootMargin: '0px 0px -50px 0px'
    });
    
    observer.observe(statsContainer);
  }
  
  // Single fetch call - script runs at end of body so DOM is ready
  fetchGitHubStats();
</script>

<style is:global>
  /* GitHub Activity specific styles - glass-panel base is in shared.css */
  .contribution-graph {
    filter: grayscale(0);
  }
  
  [data-theme="black"] .contribution-graph {
    filter: invert(1) hue-rotate(180deg);
  }
  
  .stat-number {
    color: oklch(var(--p));
    text-shadow: 0 0 20px oklch(var(--p) / 0.3);
  }
  
  [data-theme="black"] .stat-number {
    color: #ffffff !important;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
  }
  
  .private-repos-label {
    color: oklch(var(--p));
  }
  
  [data-theme="black"] .private-repos-label {
    color: #ffffff !important;
  }
  
  .stat-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
  }
  
  .stat-card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 10px 30px -10px oklch(var(--p) / 0.3);
    border-color: oklch(var(--p) / 0.4);
  }
  
  /* Skeleton graph shimmer - specific timing for this component */
  .skeleton-graph {
    animation: shimmer 2s ease-in-out infinite;
  }
</style>
