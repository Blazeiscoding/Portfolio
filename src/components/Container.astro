---
import AccordionLayout from "../layouts/AccordionLayout.astro";
import Card from "./Card.astro";
import ContactCard from "./ContactCard.astro";
import Skills from "./Skills.astro";
import GitHubActivity from "./GitHubActivity.astro";

// TypeScript interfaces for markdown frontmatter
interface WorkFrontmatter {
  title: string;
  date: string;
  tags?: string[];
  url?: string;
  org?: string;
  location?: string;
}

interface ProjectFrontmatter {
  title: string;
  date: string;
  tags?: string[];
  url?: string;
  image?: string;
  github?: string;
}

interface StudyFrontmatter {
  title: string;
  date: string;
  tags?: string[];
  location?: string;
  institute?: string;
}

interface ContactFrontmatter {
  title: string;
  url: string;
  icon: string;
}

interface MarkdownFile<T> {
  frontmatter: T;
  compiledContent: () => string;
  url?: string;
}

const worksGlob = import.meta.glob<MarkdownFile<WorkFrontmatter>>("../pages/works/*.md", { eager: true });
const projectsGlob = import.meta.glob<MarkdownFile<ProjectFrontmatter>>("../pages/projects/*.md", { eager: true });
const studiesGlob = import.meta.glob<MarkdownFile<StudyFrontmatter>>("../pages/studies/*.md", { eager: true });
const contactGlob = import.meta.glob<MarkdownFile<ContactFrontmatter>>("../pages/contact/*.md", { eager: true });

const works = Object.values(worksGlob);
const projects = Object.values(projectsGlob);
const studies = Object.values(studiesGlob);
const contact = Object.values(contactGlob);

// Sort by date (newest first) - extract year from date string
const sortByDate = <T extends { frontmatter: { date: string } }>(items: T[]): T[] => {
  return [...items].sort((a, b) => {
    const dateA = a.frontmatter.date || "";
    const dateB = b.frontmatter.date || "";
    
    // Convert to string if it's a number
    const dateAStr = String(dateA);
    const dateBStr = String(dateB);
    
    // Extract year (assumes format like "2024" or "2024 - Present")
    const yearA = parseInt(dateAStr.split(" - ")[0]) || 0;
    const yearB = parseInt(dateBStr.split(" - ")[0]) || 0;
    
    return yearB - yearA; // Descending order (newest first)
  });
};

const sortedWorks = sortByDate(works);
const sortedProjects = sortByDate(projects);
const sortedStudies = sortByDate(studies);
---

<div class="join join-vertical gap-4">
  <section id="skills" class="scroll-mt-32">
    <AccordionLayout title={"Skills"} icon={"carbon:skill-level"}>
      <Skills />
    </AccordionLayout>
  </section>

  <section id="projects" class="scroll-mt-32">
    <AccordionLayout title={"Projects"} icon={"carbon:tools"}>
      {
        sortedProjects.map((item) => {
          return (
            <Card
              title={item.frontmatter.title}
              timeframe={item.frontmatter.date}
              description={item.compiledContent()}
              tags={item.frontmatter.tags}
              url={item.frontmatter.url}
              url_name={"View project"}
              image={item.frontmatter.image}
              github={item.frontmatter.github}
            />
          );
        })
      }
    </AccordionLayout>
  </section>

  <section id="work" class="scroll-mt-32">
    <AccordionLayout title={"Work"} icon={"carbon:construction"}>
      {
        sortedWorks.map((item) => {
          return (
            <Card
              title={item.frontmatter.title}
              timeframe={item.frontmatter.date}
              description={item.compiledContent()}
              tags={item.frontmatter.tags}
              url={item.frontmatter.url}
              url_name={item.frontmatter.org}
              location={item.frontmatter.location}
            />
          );
        })
      }
    </AccordionLayout>
  </section>

  <section id="studies" class="scroll-mt-32">
    <AccordionLayout title={"Studies"} icon={"carbon:education"}>
      {
        sortedStudies.map((item) => {
          return (
            <Card
              title={item.frontmatter.title}
              timeframe={item.frontmatter.date}
              location={item.frontmatter.location}
              tags={item.frontmatter.tags}
              url={item.url}
              url_name={item.frontmatter.institute}
            />
          );
        })
      }
    </AccordionLayout>
  </section>

  <section id="github" class="scroll-mt-32">
    <AccordionLayout title={"GitHub"} icon={"carbon:logo-github"}>
      <GitHubActivity username="Blazeiscoding" />
    </AccordionLayout>
  </section>

  <section id="contact" class="scroll-mt-32">
    <AccordionLayout title={"Contact"} icon={"carbon:location-person"}>
      <div class="flex flex-wrap content-around gap-4 justify-center">
        {
          contact.map((item) => {
            return (
              <ContactCard
                url={item.frontmatter.url}
                url_name={item.frontmatter.title}
                icon={item.frontmatter.icon}
              />
            );
          })
        }
      </div>
    </AccordionLayout>
  </section>
</div>
