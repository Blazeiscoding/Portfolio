{
  email {$ACME_EMAIL}
}

# Single block for both domains so HTTP-01 ACME challenge works on www (no redirect before challenge)
{$CADDY_DOMAIN}, www.{$CADDY_DOMAIN} {
  encode zstd gzip

  # Redirect www to non-www, but NOT for ACME challenge path (so Let's Encrypt can validate)
  handle host www.{$CADDY_DOMAIN} not path /.well-known/acme-challenge/* {
    redir https://{$CADDY_DOMAIN}{uri} permanent
  }

  # Don't proxy ACME challenge â€“ let Caddy serve it so cert issuance works
  handle not path /.well-known/acme-challenge/* {
    reverse_proxy portfolio:4321
  }

  tls {
    protocols tls1.2 tls1.3
  }
}

# If you just want to access by VM IP without a domain,
# comment the block above and uncomment this one:
# :80 {
#   reverse_proxy portfolio:4321
# }

